<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Qualys KnowledgeBase Search (V2 API)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --blue: #38bdf8; --text: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .search-panel { background: var(--card); padding: 25px; border-radius: 12px; border: 1px solid #334155; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .field { display: flex; flex-direction: column; }
        label { font-size: 0.75rem; color: var(--blue); margin-bottom: 5px; text-transform: uppercase; font-weight: bold; }
        input, select { padding: 10px; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; }
        .btn-search { grid-column: 1 / -1; padding: 15px; background: var(--blue); color: #0f172a; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-search:hover { background: #7dd3fc; }
        .table-wrapper { overflow-x: auto; background: var(--card); border-radius: 10px; border: 1px solid #334155; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #334155; }
        th { background: #111827; color: var(--blue); position: sticky; top: 0; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-list"></i> Qualys KB Search</h1>
        <p id="status">Ready for documented API parameters...</p>
    </div>
    
    <div class="search-panel">
        <div class="field">
            <label>Specific QIDs (ids)</label>
            <input type="text" id="ids" placeholder="e.g. 12345, 67890">
        </div>
        <div class="field">
            <label>Published After</label>
            <input type="date" id="pubAfter">
        </div>
        <div class="field">
            <label>Discovery Method</label>
            <select id="discMethod">
                <option value="">Any</option>
                <option value="Remote">Remote</option>
                <option value="Authenticated">Authenticated</option>
                <option value="RemoteOnly">RemoteOnly</option>
                <option value="AuthenticatedOnly">AuthenticatedOnly</option>
            </select>
        </div>
        <div class="field">
            <label>Patchable Only</label>
            <select id="isPatchable">
                <option value="">Either</option>
                <option value="1">Yes (is_patchable=1)</option>
                <option value="0">No (is_patchable=0)</option>
            </select>
        </div>
        
        <button class="btn-search" onclick="triggerSearch()">
            <i class="fas fa-play"></i> Run GitHub Action Search
        </button>
    </div>

    <div class="table-wrapper">
        <table id="kbTable">
            <thead id="tHead"></thead>
            <tbody id="tBody"></tbody>
        </table>
    </div>
</div>

<script>
    function triggerSearch() {
    // 1. Get the path parts (e.g., ["", "username", "repo-name"])
    const pathParts = window.location.pathname.split('/').filter(part => part !== "");
    
    // 2. Default values if we can't detect them
    let username = "YOUR_GITHUB_USERNAME"; // <-- Manually update this for a 100% fix
    let repo = "YOUR_REPO_NAME";           // <-- Manually update this for a 100% fix

    // 3. Try to detect from URL if possible
    if (pathParts.length >= 2) {
        // This works for https://username.github.io/repo-name/
        username = pathParts[0];
        repo = pathParts[1];
    } else if (window.location.hostname.includes('.github.io')) {
        // This works for https://username.github.io/
        username = window.location.hostname.split('.')[0];
        repo = pathParts[0] || repo;
    }

    const actionUrl = `https://github.com/${username}/${repo}/actions/workflows/update_kb.yml`;
    
    console.log("Redirecting to Action:", actionUrl);
    
    alert("Instructions:\n1. Click 'Run workflow' on the next page.\n2. Enter your QIDs/Dates.\n3. Wait 1 min for the table to update.");
    
    window.open(actionUrl, '_blank');
}

    async function loadData() {
        try {
            const res = await fetch('data.json');
            const json = await res.json();
            if (json.data && json.data.length > 0) {
                const cols = Object.keys(json.data[0]);
                document.getElementById('tHead').innerHTML = `<tr>${cols.map(c => `<th>${c}</th>`).join('')}</tr>`;
                document.getElementById('tBody').innerHTML = json.data.map(row => `
                    <tr>${cols.map(c => `<td>${row[c] || ''}</td>`).join('')}</tr>
                `).join('');
                document.getElementById('status').innerText = `Results: ${json.data.length} (Synced: ${json.last_updated})`;
            }
        } catch (e) { document.getElementById('status').innerText = "Waiting for initial search results..."; }
    }
    loadData();
</script>
</body>
</html>
